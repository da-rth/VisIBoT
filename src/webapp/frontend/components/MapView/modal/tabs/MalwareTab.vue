<template>
  <div v-if="activeMarker.payloads" role="tablist" class="malware-tablist">
    <div v-for="(payload, index) in activeMarker.payloads" :key="index">
      <b-card v-if="'lisa' in payload" no-body class="mb-2 malware-card">
        <b-card-header header-tag="header" class="p-1" role="tab">
          <b-button
            v-b-toggle="'accordion-productdetails' + index"
            block
            variant="primary"
            class="malware-tab-btn"
          >
            <span>
              {{ payload.lisa.file_name }}
              <b-badge v-if="payload.keyword" class="ml-1">{{
                payload.keyword
              }}</b-badge>
            </span>
            <span>
              {{ payload.lisa.timestamp }}
            </span>
          </b-button>
        </b-card-header>

        <b-collapse
          :id="'accordion-productdetails' + index"
          visible
          :accordion="'productdetails-accordion' + index"
          role="tabpanel"
        >
          <div class="container-fluid">
            <b-tabs content-class="mt-3" class="malware-tabs-group">
              <b-tab :title="$t('Static Analysis')" active>
                <i18n
                  path="This binary was executed and analysed for a total of {num_secs} seconds using the {lisa_sandbox}"
                  tag="p"
                  class="mb-2"
                >
                  <strong slot="num_secs">{{
                    payload.lisa.exec_time || 30
                  }}</strong>
                  <a
                    slot="lisa_sandbox"
                    href="https://github.com/danieluhricek/LiSa"
                  >
                    Lisa Sandbox
                  </a>
                </i18n>
                <h6 class="pt-2 font-weight-bold">
                  {{ $t("Binary Information:") }}
                </h6>
                <code-block :content="getBinaryInfo(payload)" />

                <h6 class="pt-2 font-weight-bold">
                  {{ $t("Relevant Strings:") }}
                </h6>
                <code-block
                  :content="
                    JSON.stringify(payload.lisa.static_strings, null, 2)
                  "
                />
              </b-tab>

              <b-tab :title="$t('Network Analysis')">
                <i18n
                  path="This binary was executed and analysed for a total of {num_secs} seconds using the {lisa_sandbox}"
                  tag="p"
                  class="mb-2"
                >
                  <strong slot="num_secs">{{
                    payload.lisa.exec_time || 30
                  }}</strong>
                  <a
                    slot="lisa_sandbox"
                    href="https://github.com/danieluhricek/LiSa"
                  >
                    Lisa Sandbox
                  </a>
                </i18n>
                <template
                  v-if="payload.lisa.network_analysis.anomalies.length > 0"
                >
                  <h6 class="pt-2 font-weight-bold">Network Anomalies:</h6>
                  <code-block
                    :content="
                      JSON.stringify(
                        payload.lisa.network_analysis.anomalies,
                        null,
                        2
                      )
                    "
                  />
                </template>

                <template
                  v-if="payload.lisa.network_analysis.dns_questions.length > 0"
                >
                  <h6 class="pt-2 font-weight-bold">DNS Queries:</h6>
                  <code-block
                    :content="
                      JSON.stringify(
                        payload.lisa.network_analysis.dns_questions,
                        null,
                        2
                      )
                    "
                  />
                </template>

                <template v-if="payload.lisa.network_analysis.port_statistics">
                  <h6 class="pt-2 font-weight-bold">
                    {{ $t("Port Statistics:") }}
                  </h6>
                  <code-block
                    :content="
                      JSON.stringify(
                        payload.lisa.network_analysis.port_statistics,
                        null,
                        2
                      )
                    "
                  />
                </template>
              </b-tab>

              <b-tab
                :disabled="!payload.lisa.virustotal.total"
                :title="$t('VirusTotal')"
              >
                <i18n
                  path="This VirusTotal Report was created using the {vt_href}"
                  tag="p"
                  class="mb-2"
                >
                  <a slot="vt_href" href="https://developers.virustotal.com/">
                    VirusTotal Developer API
                  </a>
                </i18n>
                <h6 class="pt-2 font-weight-bold">
                  {{ $t("Report Summary:") }}
                </h6>

                <code-block :content="getVirusTotalInfo(payload)" />
                <p>
                  {{ $t("Want to view the full report?") }}
                  <a
                    :href="payload.lisa.virustotal.permalink"
                    class="font-weight-bold"
                  >
                    {{ $t("Follow this link") }}
                  </a>
                </p>
              </b-tab>
            </b-tabs>
          </div>
        </b-collapse>
      </b-card>
    </div>
  </div>
</template>
<script>
export default {
  computed: {
    activeMarker() {
      return this.$store.state.map.activeMarker
    },
    selectedLang() {
      return this.$store.state.settings.selectedLang
    },
    currentLocale() {
      return this.$i18n.locales.filter((i) => i.code === this.$i18n.locale)[0]
    },
  },
  methods: {
    getBinaryInfo(payload) {
      delete payload.lisa.binary_info.type
      delete payload.lisa.binary_info.min_opsize
      delete payload.lisa.binary_info.max_opsize
      delete payload.lisa.binary_info.relocations
      delete payload.lisa.binary_info.interpret

      payload.lisa.binary_info.md5 = payload.lisa.md5
      payload.lisa.binary_info.sha1 = payload.lisa.sha1
      payload.lisa.binary_info.sha256 = payload.lisa.sha256
      return JSON.stringify(payload.lisa.binary_info, null, 2)
    },
    getVirusTotalInfo(payload) {
      return JSON.stringify(
        {
          "scan date": payload.lisa.virustotal.scan_date,
          "top keyword": payload.lisa.keyword,
          "positive results": `${payload.lisa.virustotal.positives}/${payload.lisa.virustotal.total}`,
          md5: payload.lisa.virustotal.md5,
          sha1: payload.lisa.virustotal.sha1,
          sha256: payload.lisa.virustotal.sha256,
        },
        null,
        2
      )
    },
  },
}
</script>

<style>
.modalBody button.close.b-form-tag-remove {
  display: none;
}
.modalBody .table th {
  border-top: none;
}
.modalBody .table .connectionLink {
  color: #282828;
}
.malware-tab-btn {
  justify-content: space-between;
  display: flex;
}
.malware-tablist .tab-content {
  overflow: auto !important;
  margin-top: 0 !important;
  max-height: initial !important;
  min-height: initial !important;
}
.malware-card {
  border: 1px solid rgba(0, 0, 0, 0.5);
}
</style>
